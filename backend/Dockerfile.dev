FROM node:20.19.2-bookworm

WORKDIR /usr/src/app

# Install security updates
RUN apt-get update && apt-get upgrade -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create non-root user for security
RUN groupadd --gid 1001 --system nodejs && \
    useradd --uid 1001 --system --gid nodejs --shell /bin/bash nodejs

# Copy package.json and package-lock.json first for better caching
COPY package*.json ./

# Install ALL dependencies including development dependencies
RUN npm install && npm cache clean --force
RUN npm install -g nodemon ts-node

# Copy the rest of the code
COPY . .

# Change ownership to nodejs user
RUN chown -R nodejs:nodejs /usr/src/app
USER nodejs

# Expose the application port
EXPOSE 5000

# Set environment variables
ENV NODE_ENV=development

# Add healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=20s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:5000/api/health || exit 1

# Run the development server
CMD ["npm", "run", "dev"]
