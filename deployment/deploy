#!/bin/bash
# ======================================================================
# ALA Medical Application - Production Deployment
# ======================================================================
# Because deployment should be boring
#
# Usage:
#   ./deploy                    # Build from scratch (standard)
#   ./deploy --from-staging     # Use staging-tested images (fast)
#
# This script:
# 1. Backs up the database
# 2. Deploys new version (build OR promote from staging)
# 3. Verifies health
# 4. Rolls back if anything fails
#
# Image Promotion Workflow:
#   ./deploy-staging          # Build and test in staging
#   ./deploy --from-staging   # Promote to production (30 sec)

set -euo pipefail

# ======================================================================
# Configuration
# ======================================================================
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
BACKUP_DIR="$PROJECT_ROOT/backups"
BACKUP_FILE="$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).sql"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# ======================================================================
# Helper Functions
# ======================================================================
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $*"
}

success() {
    echo -e "${GREEN}âœ… $*${NC}"
}

warning() {
    echo -e "${YELLOW}âš ï¸  $*${NC}"
}

error() {
    echo -e "${RED}âŒ $*${NC}"
}

# ======================================================================
# Main Deployment
# ======================================================================
main() {
    cd "$SCRIPT_DIR"

    # Check for --from-staging flag
    USE_STAGING_IMAGES=false
    if [ "${1:-}" = "--from-staging" ]; then
        USE_STAGING_IMAGES=true
        log "Using staging-tested images (image promotion mode)"
    fi

    # Check prerequisites
    log "Checking prerequisites..."
    command -v docker >/dev/null 2>&1 || { error "Docker not found"; exit 1; }
    command -v docker-compose >/dev/null 2>&1 || { error "docker-compose not found"; exit 1; }
    [ -f .env ] || { error ".env file not found. Copy from .env.production.template"; exit 1; }
    success "Prerequisites OK"

    # Check disk space before deployment
    DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ "$DISK_USAGE" -gt 85 ]; then
        warning "Disk usage is ${DISK_USAGE}% - deployment may fail if space runs out"
        log "Automatic cleanup will run after successful deployment..."
    else
        log "Disk usage: ${DISK_USAGE}%"
    fi

    # If using staging images, check they exist
    if [ "$USE_STAGING_IMAGES" = true ]; then
        if ! docker images | grep -q "ala-api.*staging"; then
            error "Staging images not found. Run ./deploy-staging first"
            exit 1
        fi
        success "Staging images found"
    fi

    # Create backup directory
    mkdir -p "$BACKUP_DIR"

    # Backup database
    log "Backing up database..."
    if docker-compose exec -T db pg_dump -U "${POSTGRES_USER:-ala_user}" "${POSTGRES_DB:-ala_production}" > "$BACKUP_FILE" 2>/dev/null; then
        success "Backup saved: $BACKUP_FILE ($(du -h "$BACKUP_FILE" | cut -f1))"
    else
        warning "Database backup failed (container may not be running yet)"
        touch "$BACKUP_FILE"  # Create empty backup file
    fi

    # Deploy new version
    if [ "$USE_STAGING_IMAGES" = true ]; then
        log "Deploying from staging images (no rebuild)..."
        log "  Tagging staging images as production..."
        docker tag ala-api:staging ala-api:production
        docker tag ala-frontend:staging ala-frontend:production
        success "Images promoted"
    else
        log "Deploying new version (building from source)..."
        log "  Pulling latest code..."
        cd "$PROJECT_ROOT" && git pull origin main

        cd "$SCRIPT_DIR"
        log "  Building containers..."
        docker-compose build --no-cache
    fi

    log "  Starting services..."
    docker-compose up -d

    # Wait for health checks
    log "Waiting for health checks (60s)..."
    sleep 60

    # Verify deployment
    log "Verifying deployment..."

    if curl -f -s http://localhost:5000/api/health > /dev/null 2>&1; then
        success "Backend healthy"
    else
        error "Backend unhealthy - Rolling back..."
        rollback "$BACKUP_FILE"
        exit 1
    fi

    if curl -f -s http://localhost:80 > /dev/null 2>&1 || curl -f -s http://localhost:8080 > /dev/null 2>&1; then
        success "Frontend healthy"
    else
        warning "Frontend check failed (non-critical, may be nginx port config)"
    fi

    # Clean up Docker resources after successful deployment
    # Note: Intentionally duplicated in deploy-staging for simplicity
    log "Cleaning up Docker resources..."
    DISK_BEFORE=$(df -h / | awk 'NR==2 {print $5}')
    docker image prune -f
    docker builder prune -f --keep-storage 1GB
    DISK_AFTER=$(df -h / | awk 'NR==2 {print $5}')
    success "Docker cleanup complete (disk usage: $DISK_BEFORE â†’ $DISK_AFTER)"

    # Success!
    echo ""
    success "ðŸŽ‰ Deployment successful!"
    echo ""
    echo "  Frontend: http://$(hostname -I | awk '{print $1}')"
    echo "  Backend:  http://$(hostname -I | awk '{print $1}'):5000/api"
    echo "  Health:   http://$(hostname -I | awk '{print $1}'):5000/api/health"
    echo ""
    echo "  Backup:   $BACKUP_FILE"
    echo ""
    echo "Monitor logs: cd $SCRIPT_DIR && docker-compose logs -f"

    # Keep only last 10 backups
    log "Cleaning up old backups..."
    cd "$BACKUP_DIR" && ls -t backup-*.sql 2>/dev/null | tail -n +11 | xargs -r rm
}

# ======================================================================
# Rollback Function
# ======================================================================
rollback() {
    local backup_file=$1

    error "Deployment failed - initiating rollback"

    cd "$SCRIPT_DIR"
    docker-compose down

    if [ -f "$backup_file" ] && [ -s "$backup_file" ]; then
        log "Restoring database from backup..."
        docker-compose up -d db
        sleep 10
        cat "$backup_file" | docker-compose exec -T db psql -U "${POSTGRES_USER:-ala_user}" "${POSTGRES_DB:-ala_production}"
    fi

    docker-compose up -d
    error "Rolled back to previous version"
}

# ======================================================================
# Execute
# ======================================================================
main "$@"
